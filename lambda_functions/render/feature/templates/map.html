<div id="campaign-map-detail"></div>
<script type="text/javascript">

  var map = createMap();

  setTitleLayer(map);
  setViewFromCampaign(map);
  renderMap(map);


  function createMap() {
    return L.map('campaign-map-detail').setView([0, 0], 1);
  }
    
  function setTitleLayer(map) {
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
        '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      id: 'mapbox.light'
    }).addTo(map);
  }

  function setViewFromCampaign(map) {
      
    geometry = {{ geometry }}
    campaign_layer = L.geoJSON(geometry);
    map.addLayer(campaign_layer);
    map.fitBounds(campaign_layer.getBounds());

    return map;
  }

  function renderMap(map) {
    var geojsonFilesCount = {{ feature_completeness['geojson_files_count']}};

    for (var i = 1; i <= geojsonFilesCount; i++) {
      var geojsonUrl = "{{ url | safe }}" + '/geojson_' + i + '.json';
      $.ajax({
        url: geojsonUrl,
        dataType: 'json',
        success: function(data) {
          L.geoJSON(data, {
            pointToLayer: function (feature, latlng) {
              return L.circle(latlng, {
                radius: 5,
                fillColor: feature.properties.completeness_color,
                color: feature.properties.completeness_color,
                weight: 5,
                opacity: 1,
                fillOpacity: 0.8
                });
            },
            onEachFeature: onEachFeature,
            style: function(feature) {
              return {color: feature.properties.completeness_color}
            }
          }).addTo(map);
        }
      });
    }
  }

  function onEachFeature(feature, layer) {
    link = `<a href="https://www.openstreetmap.org/${feature.properties.type}/${feature.id}" target="_blank">https://www.openstreetmap.org/${feature.properties.type}/${feature.id}</a>`;
    content = `${link}<br />`;

    type = `<b>type</b> : ${feature.properties.type}`;
    content += `${type}<br />`;

    if (feature.properties.errors !== null) {
      errors = `<div style='color:red'><b>errors</b> : ${feature.properties.errors}</div>`;
      content += errors;
    }

    if (feature.properties.warnings !== null) {
      warnings = `<div style='color:orange'><b>warnings</b> : ${feature.properties.warnings}</div>`
      content += warnings;
    }    

    tags = []
    for (var tag in feature.properties.tags) {
      tag_to_s = `<b>${tag}</b> : ${feature.properties.tags[tag]}`
      tags.push(tag_to_s)
    }
    tags = tags.join('<br />')
  
    content += `${tags}<br />`;
    
    percentage = `<b>completeness</b> : ${feature.properties.completeness_pct}`;

    content += percentage;

    
    layer.bindPopup(content);
  } 

</script>
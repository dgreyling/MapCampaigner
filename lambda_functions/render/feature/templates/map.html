<div id="campaign-map-detail"></div>
<script type="text/javascript">

  var map = createMap();

  setTitleLayer(map);
  setViewFromCampaign(map);
  renderMap(map);


  function createMap() {
    return L.map('campaign-map-detail').setView([0, 0], 1);
  }
    
  function setTitleLayer(map) {
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
      maxZoom: 18,
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
        '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      id: 'mapbox.light'
    }).addTo(map);
  }

  function setViewFromCampaign(map) {
      
    geometry = {{ geometry }}
    campaign_layer = L.geoJSON(geometry);
    map.addLayer(campaign_layer);
    map.fitBounds(campaign_layer.getBounds());

    return map;
  }

  function renderMap(map) {
    var geojsonFilesCount = {{ feature_completeness['geojson_files_count']}};

    for (var i = 1; i <= geojsonFilesCount; i++) {
      var geojsonUrl = "{{ url | safe }}" + '/geojson_' + i + '.json';
      $.ajax({
        url: geojsonUrl,
        dataType: 'json',
        success: function(data) {
          L.geoJSON(data, {
            pointToLayer: function (feature, latlng) {
              return L.circle(latlng, {
                radius: 5,
                fillColor: feature.properties.completeness_color,
                color: feature.properties.completeness_color,
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
                });
            },
            onEachFeature: onEachFeature,
            style: function(feature) {
              return {color: feature.properties.completeness_color}
            }
          }).addTo(map);
        }
      });
    }
  }

  function onEachFeature(feature, layer) {
    content = `${feature.properties.completeness_pct}`
    layer.bindPopup(content);
  } 

</script>
{% extends 'new_base.html' %}

{% block extra_title %}
    - {{ name }}
{% endblock %}

{% block extra_head %}
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Map Campaigner" />
    <meta property="og:description" content="{{ description }}" />
{% endblock %}

{% block header_content %}

    <script src="http://connect.facebook.net/en_US/all.js" async=""></script>

    <!-- Custom CSS -->
    <link href="/static/css/campaign-detail.css" rel="stylesheet">

{% endblock %}


{% block content %}

    <div class="row">
        <div class="col-lg-7">
            <h3 class="detail-campaign-name">{{ name }}</h3>
            {% if types %}
                {% for type in types %}
                    <label class="detail-tag"> {{ type }} </label>
                {% endfor %}
            {% endif %}
            <p>
                {% if description %}
                    {{ description }}
                {% else %}
                    <span class="grey-italic">No description</span>
                {% endif %}
            </p>
            <div class="row">
            <div class="col-lg-6 detail-button-wrapper participate-button" style="margin-top: 20px">
                <span class="btn btn-label"><strong>Participate</strong></span>
                <div class="btn-group btn-share-group" role="group" aria-label="...">
                    {% if link_to_omk %}
                        <button type="button" id="btn-omk-link" class="btn btn-default" onclick="openOtherDataCollectonForm(this, 'OpenMapKit')"><i class="fa fa-mobile" aria-hidden="true"></i> OpenMapKit</button>
                    {% endif %}
                    <button type="button" id="btn-mapsme-link" class="btn btn-default" onclick="openOtherDataCollectonForm(this, 'Maps.me')"><i class="fa fa-mobile" aria-hidden="true"></i> Maps.me</button>
                </div>
            </div>
            <div class="col-lg-6 detail-button-wrapper" style="margin-top: 25px;">
                <div class="btn-group btn-share-group" role="group" aria-label="..." style="float: right;">
                    <span class="btn btn-default unclickable" >Share</span>
                    <button type="button" class="btn btn-default" onclick="shareTweet('{{ uuid }}')"> <i class="fa fa-twitter" aria-hidden="true"></i> </button>
                    <button type="button" class="btn btn-default" onclick="shareFacebook()"> <i class="fa fa-facebook" aria-hidden="true"></i> </button>
                </div>
            </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="panel panel-default detail-panel-information">
                <div class="panel-body">
                    <div class="detail-campaign-status {{ current_status }}">
                        <i class="fa fa-circle" aria-hidden="true"></i> <label>{{ current_status }}</label>
                    </div>
                    <div class="detail-campaign-timeline">
                        <span class="pull-left">
                            <i class="fa fa-calendar-o" aria-hidden="true"></i> <span class="grey-italic">Started</span> : {{ start_date_date }} {{ start_date_year }}
                        </span>
                        <span class="pull-right">
                            <i class="fa fa-calendar-o" aria-hidden="true"></i> <span class="grey-italic">Ends</span> : {{ end_date_date }} {{ end_date_year }}
                        </span>
                    </div>
                    <div class="detail-progress">
                        <div class="progress">
                            <div class="progress-bar" id="campaign-progress" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    <div class="detail-creator-info">
                        <p>
                            <span class="grey-italic">Campaign Manager : </span>
                            <span class="text-muted">
                                {% if campaign_managers %}
                                    {% for campaign_manager in campaign_managers %}
                                        <a href="https://www.openstreetmap.org/user/{{ campaign_manager }}" target="_blank">{{ campaign_manager }}</a>
                                        {% if campaign_manager != campaign_managers[-1] %}
                                            ,
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    -
                                {% endif %}
                            </span>
                        </p>
                        <p>
                            <span class="grey-italic">Creator : </span>
                            <a href="https://www.openstreetmap.org/user/{{ campaign_creator }}" target="_blank">
                            {{ campaign_creator }}
                            </a>
                        </p>
                        <p>
                            <span class="grey-italic">Map:</span>
                            {% if map_type != '' and map_type != 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' %}
                                <span id="map-default" style="display: none">
                                Default
                                </span>
                                <span id="map-custom">
                                Custom
                                </span>
                            {% else %}
                                <span id="map-default"></span>
                                Default
                            {% endif %}
                        </p>
                    </div>
                    <div class="button-manage">
                        <button class="btn btn-info btn-manage" onclick="location.href='/edit/{{ uuid }}'">Manage</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class='row' id='campaign-computing-status'>
        <div class='col-lg-12'>
            <div class='alert alert-warning'>
                <p>The campaign is still computing, please come back later.</p>
            </div>
        </div>
    </div>
    <div class='row' id="campaign-feature-details" style="display:none">
      <div class='col-lg-12'>
        <div class='panel panel-default detail-panel-information'>
          <div class='panel-body'>
            <div class="type-title">
            <i class="glyphicon glyphicon-info-sign"></i>
            Feature details
            </div>
            <div class='row side-panel-wrapper'>
              <div class='col-lg-4 map-side-panel'>
                <select class="select-types feature-select form-control">
                {% for type in types %}
                  <option value='{{ type }}'>{{ type }}</option>
                {% endfor %}
                </select>
                <div class="content-wrapper"></div>
              </div>
              <div class='col-lg-8'>
                <div class='map-wrapper'></div>
              </div>
            </div>
            <div class="col-lg-12">
              <div class="errors-wrapper"></div>
          </div>
        </div>
      </div>
    </div>

{% endblock %}

{% block before_base_js %}
    <script type="text/javascript">

    </script>
{% endblock %}

{% block after_base_js %}

    <script type="text/javascript">
    function main() {
      var s3CampaignUrl = '{{ s3_campaign_url | safe }}';
      var types = {{ types|safe }};
      var activeType = types[0];
      
      loadType(activeType, s3CampaignUrl);

      // calculateCampaignProgress();

      
      $('.feature-select').on('change', function() {
        activeType = this.value;
        loadType(activeType, s3CampaignUrl);
      });      

    }

    function loadType(activeType, s3CampaignUrl) {
      activeType = activeType.replace(' ', '_')
      var typeUrl = getTypeUrl(activeType, s3CampaignUrl);  

      $.get(typeUrl + 'content.html', function(data) {
            $('#campaign-feature-details').show();
            $('#campaign-computing-status').hide();
            $('.content-wrapper').html(data);        
      });

      $.get(typeUrl + 'map.html', function(data) {
        $('.map-wrapper').html(data)
      });

      $.get(typeUrl + 'errors.html', function(data) {
        $('.errors-wrapper').html(data)
      });        
    }

    function calculateCampaignProgress() {
      var start_date = "{{ start_date }}";
      var end_date = "{{ end_date }}";


        var $campaignStatus = $('.detail-campaign-status');
        var $campaignStatusLabel = $('.detail-campaign-status label');

        if (start_date === 'None' || end_date === 'None') {
            $('.detail-campaign-status label').html('-');
            return;
        }

        start_date = moment(start_date, 'YYYY-MM-DD', true);
        end_date = moment(end_date, 'YYYY-MM-DD', true);
        var campaign_range = end_date.diff(start_date, 'days') + 1; // Include start
        if (campaign_range < 0) {
            $campaignStatusLabel.html('-');
            return;
        }

        var remaining_days = end_date.diff(moment(), 'days') + 1;
        var progress = 0;
        if (remaining_days <= 0) {
            progress = 100;
            if($campaignStatusLabel.text() == 'Inactive') {
                $campaignStatus.removeClass('running');
                $campaignStatus.addClass('finished');
                $campaignStatusLabel.html('Finished');
            }
        } else {
            progress = 100 - (remaining_days / campaign_range * 100);
            if(progress < 0){
                progress = 0
            }
        }
        $('#campaign-progress').css({
            'width': progress + '%'
        });
    }

    function getTypeUrl(activeType, s3CampaignUrl) {
      return s3CampaignUrl + '/render/' + activeType + '/';      
    }    

    main();
    </script>
{% endblock %}